name: release-artifacts

on:
  # push:
  #   tags:
  #     - "v*"
  push:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MIX_ENV: prod
  NX_IREE_PREFER_PRECOMPILED: "false"
  BUILD_CACHE: ${{ github.workspace }}/build_cache

jobs:
  download_iree:
    runs-on: macos-14
    strategy:
      matrix:
        OTP_VERSION: ["27.0"]
        ELIXIR_VERSION: ["1.15.4"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Erlang and Elixir
        run: |
          brew install autoconf coreutils curl git openssl wxwidgets asdf
          asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
          asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git
          export KERL_CONFIGURE_OPTIONS="--disable-debug --without-javac"
          asdf install erlang ${{ matrix.OTP_VERSION }}
          asdf install elixir ${{ matrix.ELIXIR_VERSION }}
          asdf global erlang ${{ matrix.OTP_VERSION }}
          asdf global elixir ${{ matrix.ELIXIR_VERSION }}
          source $(brew --prefix asdf)/libexec/asdf.sh
          mix local.hex --force
          mix local.rebar --force

      - name: Cache mix packages
        id: cache-mix-deps
        uses: actions/cache@v4
        with:
          key: deps-${{ hashFiles('mix.lock') }}
          path: |
            ./deps

      - name: Get mix deps
        if: steps.cache-mix-deps.outputs.cache-hit != 'true'
        run: |
          source $(brew --prefix asdf)/libexec/asdf.sh
          mix deps.get

      - name: Get IREE version
        id: get-iree-version
        run: echo "iree_version=$(mix iree.version)" >> $GITHUB_ENV

      - name: Cache IREE source code
        id: cache-iree
        uses: actions/cache@v4
        with:
          key: iree-${{ env.iree_version }}
          path: |
            ${{ env.BUILD_CACHE }}/iree

      - name: Download IREE source code
        if: steps.cache-iree.outputs.cache-hit != 'true'
        run: |
          bash scripts/clone_iree.sh ${{ env.BUILD_CACHE }} ${{ env.iree_version }} '${{ env.BUILD_CACHE }}/iree'

  build_artifacts:
    runs-on: macos-14
    needs: download_iree
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Erlang and Elixir
        run: |
          brew install autoconf coreutils curl git openssl wxwidgets asdf ffmpeg
          brew link ffmpeg
          asdf plugin add erlang https://github.com/asdf-vm/asdf-erlang.git
          asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git
          export KERL_CONFIGURE_OPTIONS="--disable-debug --without-javac"
          asdf install erlang ${{ matrix.pair.OTP_VERSION }}
          asdf install elixir ${{ matrix.pair.ELIXIR_VERSION }}
          asdf global erlang ${{ matrix.pair.OTP_VERSION }}
          asdf global elixir ${{ matrix.pair.ELIXIR_VERSION }}
          source $(brew --prefix asdf)/libexec/asdf.sh
          mix local.hex --force
          mix local.rebar --force

      - name: Cache mix packages
        id: cache-mix-deps
        uses: actions/cache/restore@v4
        with:
          key: deps-${{ hashFiles('mix.lock') }}
          path: |
            ./deps

      - name: Get IREE version
        id: get-iree-version
        run: |
          source $(brew --prefix asdf)/libexec/asdf.sh
          echo "iree_version=$(mix iree.version)" >> $GITHUB_ENV

      - name: Cache IREE source code
        id: cache-iree
        uses: actions/cache/restore@v4
        with:
          key: iree-${{ env.iree_version }}
          path: |
            ${{ env.BUILD_CACHE }}/iree

      - name: Build IREE
        run: |
          IREE_DIR=${{ env.BUILD_CACHE }}/iree make compile
